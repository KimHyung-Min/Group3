<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="booktrain.purchase">

    <insert id="insertPurchase" parameterType="hashMap" useGeneratedKeys="true" keyColumn="order_number"
            keyProperty="orderNumber">
        <choose>
            <when test="memberTel != null">
                INSERT INTO PURCHASE (ORDER_NUMBER, MEMBERTEL,STATE, TOTAL_PRICE, PURCHASE_DATE, RECEIVER, SHIP_ADDRESS)
                VALUES (SEQ_ORDER_NUMBER.nextval, #{memberTel}, '결제완료', #{totalPrice}, sysdate, #{receiver},
                #{shipAddress})
            </when>
            <otherwise>
                INSERT INTO PURCHASE (ORDER_NUMBER, NONMEMBERTEL, STATE, TOTAL_PRICE, PURCHASE_DATE, RECEIVER,
                SHIP_ADDRESS)
                VALUES (SEQ_ORDER_NUMBER.nextval, #{nonMemberTel}, '결제완료', #{totalPrice}, sysdate,#{receiver},
                #{shipAddress})
            </otherwise>
        </choose>
    </insert>

    <select id="selectSalesData" parameterType="purchaseBook" resultType="purchaseBook">
        SELECT ISBN
        FROM SALES_DATA
        where ISBN =#{isbn}
    </select>

    <insert id="insertPurchaseBook" parameterType="purchaseBook">
        INSERT INTO PURCHASE_BOOK (ORDER_NUMBER, ISBN, QUANTITY)
        VALUES (#{orderNumber}, #{isbn}, #{quantity})
    </insert>

    <insert id="insertSalesData" parameterType="purchaseBook">
        INSERT INTO SALES_DATA (ISBN, AMOUNT_QUANTITY, AMOUNT_PRICE ) VALUES
        (#{isbn}, #{quantity}, (SELECT #{quantity}*price AS  from book where isbn=#{isbn}) )
    </insert>

    <update id="updateSalesData" parameterType="purchaseBook">
        UPDATE SALES_DATA
        SET AMOUNT_QUANTITY = AMOUNT_QUANTITY + #{quantity},
         AMOUNT_PRICE = AMOUNT_PRICE + (SELECT #{quantity}*price AS  from book where isbn=#{isbn})
         WHERE isbn = #{isbn}
    </update>

    <select id="selectOrderNumber" parameterType="purchase" resultType="string">
        SELECT ORDER_NUMBER
        FROM PURCHASE
        WHERE MEMBERTEL = #{memberTel}
        ORDER BY ORDER_NUMBER DESC
    </select>

    <select id="selectOrderList" parameterType="purchase" resultMap="purchase">
       SELECT pur.order_number as order_number,
               CASE WHEN COUNT.COUNT >= 1 THEN b2.title||' 외 '||COUNT.count
                    ELSE b2.title
               END AS title,
               mem.name AS name, pur.receiver AS receiver, pur.total_price AS total_price, TO_CHAR(pur.purchase_date,'YYYY-MM-DD HH24:MI') AS purchase_date
        FROM purchase pur
              INNER JOIN (SELECT COUNT(p.order_number)-1 AS count, p.membertel AS membertel
                          FROM purchase_book pb INNER JOIN purchase p ON p.order_number = pb.order_number
                          WHERE p.membertel = #{memberTel} and p.order_number = #{orderNumber}
                          GROUP BY p.order_number, p.membertel) count
              ON pur.membertel = count.membertel
              INNER JOIN purchase_book b ON pur.order_number = b.order_number
              INNER JOIN book b2 ON b.ISBN = b2.ISBN
              INNER JOIN MEMBER mem ON pur.membertel = mem.tel
        WHERE pur.membertel = #{memberTel} and pur.order_number = #{orderNumber} AND pur.state = #{state} AND rownum = 1
    </select>

    <select id="purchaseInfo" parameterType="purchase" resultMap="purchase">
        select ORDER_NUMBER,RECEIVER, SHIP_ADDRESS,TOTAL_PRICE, PURCHASE_DATE
        from PURCHASE
        where ORDER_NUMBER = #{orderNumber}
    </select>

    <select id="detailOrder" parameterType="purchase" resultMap="purchase">
      select b.title AS title, b.price AS price, pb.quantity AS quantity
      from purchase p inner join member m on p.membertel = m.tel
                    inner join purchase_book pb on p.order_number = pb.order_number
                    inner join book b on pb.isbn = b.isbn
      where p.order_number=#{orderNumber}
    </select>

    <resultMap id="purchase" type="purchase">
        <result property="orderNumber" column="order_number"/>
        <result property="memberTel" column="memberTel"/>
        <result property="receiver" column="receiver"/>
        <result property="totalPrice" column="total_price"/>
        <result property="shipAddress" column="ship_address"/>
        <result property="state" column="state"/>
        <result property="purchaseDate" column="purchase_date"/>
        <collection property="memberVO" resultMap="member"/>
        <collection property="purchaseBookVO" resultMap="purchaseBook"/>
        <collection property="bookVO" resultMap="book"/>
    </resultMap>

    <resultMap id="member" type="member">
        <result property="tel" column="tel"/>
        <result property="name" column="name"/>
    </resultMap>

    <resultMap id="purchaseBook" type="purchaseBook">
        <result property="orderNumber" column="order_number"/>
        <result property="isbn" column="isbn"/>
        <result property="quantity" column="quantity"/>
        <collection property="bookVO" resultMap="book"/>
    </resultMap>

    <resultMap id="book" type="book">
        <result property="isbn" column="isbn"/>
        <result property="title" column="title"/>
        <result property="price" column="price"/>
    </resultMap>

    <update id="cancelOrder_purchase" parameterType="purchase">
        UPDATE PURCHASE
        SET STATE = '결제취소', CANCEL_DATE = sysdate
        WHERE ORDER_NUMBER = #{orderNumber}
    </update>

    <update id="cancelPoint" parameterType="purchase">
        UPDATE MEMBER
        SET POINT = POINT - (SELECT 0.05*TOTAL_PRICE FROM PURCHASE WHERE ORDER_NUMBER = #{orderNumber})
        WHERE TEL = #{memberTel}
    </update>

    <delete id="cancelOrder_purchaseBook" parameterType="purchase">
        DELETE FROM PURCHASE_BOOK
        WHERE ORDER_NUMBER = #{orderNumber}
    </delete>
</mapper>